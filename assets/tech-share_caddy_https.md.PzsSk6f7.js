import{_ as s,o as n,c as i,a2 as l}from"./chunks/framework.C766EroN.js";const k=JSON.parse('{"title":"Caddy 配置 HTTPS 方式","description":"Caddy 配置 HTTPS 证书与访问方式，适配 lyedu 项目","frontmatter":{"title":"Caddy 配置 HTTPS 方式","description":"Caddy 配置 HTTPS 证书与访问方式，适配 lyedu 项目"},"headers":[],"relativePath":"tech-share/caddy/https.md","filePath":"tech-share/caddy/https.md"}'),e={name:"tech-share/caddy/https.md"};function p(t,a,d,h,r,o){return n(),i("div",null,[...a[0]||(a[0]=[l(`<blockquote><p>编辑日期：2026-02-26</p></blockquote><h1 id="caddy-配置-https-适配-lyedu-项目" tabindex="-1">Caddy 配置 HTTPS（适配 lyedu 项目） <a class="header-anchor" href="#caddy-配置-https-适配-lyedu-项目" aria-label="Permalink to &quot;Caddy 配置 HTTPS（适配 lyedu 项目）&quot;">​</a></h1><p>本文档聚焦 Caddy 配置 HTTPS 核心流程，适配 lyedu-admin、lyedu-h5 双项目，实现 HTTPS 外网访问、自动申请/续期免费证书，流程极简可直接落地。</p><h2 id="一、https-配置前提-必满足" tabindex="-1">一、HTTPS 配置前提（必满足） <a class="header-anchor" href="#一、https-配置前提-必满足" aria-label="Permalink to &quot;一、HTTPS 配置前提（必满足）&quot;">​</a></h2><ul><li>已拥有备案域名（如 lyedu.com），添加 2 条 A 记录解析：<strong>admin.lyedu.com</strong>（绑定管理后台）、<strong>h5.lyedu.com</strong>（绑定 H5 移动端），均指向服务器公网 IP；</li><li>服务器放行 <strong>80/TCP</strong>（证书验证用）、<strong>443/TCP</strong>（HTTPS 默认端口），云服务器需同步配置安全组；</li><li>Caddy 版本 ≥ 2.0（推荐 2.6+，兼容证书自动续期及日志配置）。</li></ul><h2 id="二、完整-https-配置" tabindex="-1">二、完整 HTTPS 配置 <a class="header-anchor" href="#二、完整-https-配置" aria-label="Permalink to &quot;二、完整 HTTPS 配置&quot;">​</a></h2><p><strong>配置路径</strong>：<code>/app/caddy/Caddyfile</code>，直接复制替换原有配置即可：</p><div class="language-caddyfile vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">caddyfile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{</span></span>
<span class="line"><span>    # 日志配置（可选，按日期拆分，便于排查）</span></span>
<span class="line"><span>    log {</span></span>
<span class="line"><span>        level warn</span></span>
<span class="line"><span>        output file /var/log/caddy/caddy.log {</span></span>
<span class="line"><span>            roll_size 100MB    # 单个日志文件大小阈值</span></span>
<span class="line"><span>            roll_keep 7        # 保留最近7天日志</span></span>
<span class="line"><span>            roll_keep_for 30d  # 日志最长保留30天</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    # 核心：开启自动 HTTPS（自动申请/续期 Let&#39;s Encrypt 证书）</span></span>
<span class="line"><span>    auto_https on</span></span>
<span class="line"><span>    # 证书申请邮箱（必填，用于到期提醒）</span></span>
<span class="line"><span>    email 755591110@qq.com</span></span>
<span class="line"><span>    # 关闭 admin 接口，减少端口占用</span></span>
<span class="line"><span>    admin off</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># lyedu-admin 管理后台（HTTPS 配置）</span></span>
<span class="line"><span>admin.lyedu.com {</span></span>
<span class="line"><span>    bind 0.0.0.0</span></span>
<span class="line"><span>    root * /app/ly-edu/lyedu-admin/dist</span></span>
<span class="line"><span>    encode gzip</span></span>
<span class="line"><span>    file_server</span></span>
<span class="line"><span>    try_files {path} /index.html  # 适配 Vue 路由，解决刷新404</span></span>
<span class="line"><span>    # 跨域配置（按需保留，不影响 HTTPS 生效）</span></span>
<span class="line"><span>    header {</span></span>
<span class="line"><span>        Access-Control-Allow-Origin *</span></span>
<span class="line"><span>        Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS</span></span>
<span class="line"><span>        Access-Control-Allow-Headers Content-Type,Authorization</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    # HTTP 自动跳转 HTTPS（可选，Caddy 自动处理，可省略）</span></span>
<span class="line"><span>    redir http://admin.lyedu.com https://admin.lyedu.com permanent</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># lyedu-h5 移动端（HTTPS 配置）</span></span>
<span class="line"><span>h5.lyedu.com {</span></span>
<span class="line"><span>    bind 0.0.0.0</span></span>
<span class="line"><span>    root * /app/ly-edu/lyedu-h5</span></span>
<span class="line"><span>    encode gzip</span></span>
<span class="line"><span>    file_server</span></span>
<span class="line"><span>    try_files {path} /index.html  # 适配 H5 路由，解决刷新404</span></span>
<span class="line"><span>    # 跨域配置（按需保留）</span></span>
<span class="line"><span>    header {</span></span>
<span class="line"><span>        Access-Control-Allow-Origin *</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    # HTTP 自动跳转 HTTPS（可选）</span></span>
<span class="line"><span>    redir http://h5.lyedu.com https://h5.lyedu.com permanent</span></span>
<span class="line"><span>}</span></span></code></pre></div><h2 id="三、核心配置解读-https-关键项" tabindex="-1">三、核心配置解读（HTTPS 关键项） <a class="header-anchor" href="#三、核心配置解读-https-关键项" aria-label="Permalink to &quot;三、核心配置解读（HTTPS 关键项）&quot;">​</a></h2><ol><li><strong>auto_https on</strong>：开启自动 HTTPS，Caddy 自动向 Let&#39;s Encrypt 申请免费证书，到期前自动续期（无需手动操作）；</li><li><strong>email <a href="mailto:your-email@example.com" target="_blank" rel="noreferrer">your-email@example.com</a></strong>：必填项，用于证书申请验证、到期提醒，替换为个人/企业真实邮箱；</li><li><strong>域名绑定</strong>：用子域名（admin.lyedu.com、h5.lyedu.com）替代原端口，Caddy 自动监听 443 端口，外网访问无需手动带端口；</li><li><strong>其余配置</strong>（gzip、try_files、跨域）：不影响 HTTPS 核心功能，按需保留即可。</li></ol><h2 id="四、https-配置操作步骤-完整落地" tabindex="-1">四、HTTPS 配置操作步骤（完整落地） <a class="header-anchor" href="#四、https-配置操作步骤-完整落地" aria-label="Permalink to &quot;四、HTTPS 配置操作步骤（完整落地）&quot;">​</a></h2><h3 id="_1-准备操作" tabindex="-1">1. 准备操作 <a class="header-anchor" href="#_1-准备操作" aria-label="Permalink to &quot;1. 准备操作&quot;">​</a></h3><ul><li>完成域名解析（确认 admin.lyedu.com、h5.lyedu.com 解析至服务器公网 IP）；</li><li>放行端口（防火墙 + 安全组）：<div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">firewall-cmd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --permanent</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --add-port=80/tcp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">firewall-cmd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --permanent</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --add-port=443/tcp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">firewall-cmd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --reload</span></span></code></pre></div></li><li>创建日志目录（若启用日志配置）：<div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/log/caddy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -R</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 755</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/log/caddy</span></span></code></pre></div></li></ul><h3 id="_2-修改配置文件" tabindex="-1">2. 修改配置文件 <a class="header-anchor" href="#_2-修改配置文件" aria-label="Permalink to &quot;2. 修改配置文件&quot;">​</a></h3><ul><li>执行 <code>vim /app/caddy/Caddyfile</code>，删除原有内容，粘贴上述 HTTPS 完整配置；</li><li>替换 <code>your-email@example.com</code> 为真实邮箱，替换 <code>admin.lyedu.com</code>、<code>h5.lyedu.com</code> 为实际域名。</li></ul><h3 id="_3-验证配置-重启-caddy" tabindex="-1">3. 验证配置 + 重启 Caddy <a class="header-anchor" href="#_3-验证配置-重启-caddy" aria-label="Permalink to &quot;3. 验证配置 + 重启 Caddy&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 格式化配置（规范语法，避免报错）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./caddy</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fmt</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --overwrite</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /app/caddy/Caddyfile</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 验证配置合法性</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./caddy</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> validate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /app/caddy/Caddyfile</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 停止原有 Caddy 进程</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./caddy</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 后台启动（HTTPS 生效，日志自动按日期拆分）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nohup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./caddy</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /app/caddy/Caddyfile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;</span></span></code></pre></div><h2 id="五、https-访问方式" tabindex="-1">五、HTTPS 访问方式 <a class="header-anchor" href="#五、https-访问方式" aria-label="Permalink to &quot;五、HTTPS 访问方式&quot;">​</a></h2><ul><li><strong>lyedu-admin 管理后台</strong>：<a href="https://admin.lyedu.com" target="_blank" rel="noreferrer">https://admin.lyedu.com</a>（无需带端口，自动跳转 HTTPS）；</li><li><strong>lyedu-h5 移动端</strong>：<a href="https://h5.lyedu.com" target="_blank" rel="noreferrer">https://h5.lyedu.com</a>；</li><li>若输入 <a href="http://admin.lyedu.com" target="_blank" rel="noreferrer">http://admin.lyedu.com</a>，会自动跳转至 HTTPS 安全版本。</li></ul><h2 id="六、https-常见问题排查-核心" tabindex="-1">六、HTTPS 常见问题排查（核心） <a class="header-anchor" href="#六、https-常见问题排查-核心" aria-label="Permalink to &quot;六、HTTPS 常见问题排查（核心）&quot;">​</a></h2><h3 id="_1-证书申请失败-启动报错-acme-error" tabindex="-1">1. 证书申请失败（启动报错 &quot;acme: error: ...&quot;） <a class="header-anchor" href="#_1-证书申请失败-启动报错-acme-error" aria-label="Permalink to &quot;1. 证书申请失败（启动报错 &quot;acme: error: ...&quot;）&quot;">​</a></h3><ul><li>域名未解析生效：<code>ping admin.lyedu.com</code> 验证，确认指向服务器公网 IP；</li><li>80 端口被占用：停止 Nginx/Apache 等进程（<code>systemctl stop nginx</code>）；</li><li>国内服务器域名未备案：需完成备案后再申请证书。</li></ul><h3 id="_2-https-访问提示「不安全」" tabindex="-1">2. HTTPS 访问提示「不安全」 <a class="header-anchor" href="#_2-https-访问提示「不安全」" aria-label="Permalink to &quot;2. HTTPS 访问提示「不安全」&quot;">​</a></h3><ul><li>证书未同步生效：等待 1–5 分钟，清除浏览器缓存或用隐私模式访问；</li><li>配置错误：重新验证 Caddyfile 语法（<code>./caddy validate</code>），检查域名替换是否正确。</li></ul><h2 id="七、https-补充说明" tabindex="-1">七、HTTPS 补充说明 <a class="header-anchor" href="#七、https-补充说明" aria-label="Permalink to &quot;七、HTTPS 补充说明&quot;">​</a></h2><ul><li><strong>证书有效期</strong>：Let&#39;s Encrypt 证书有效期 90 天，Caddy 自动续期，无需手动干预；</li><li><strong>回滚方案</strong>：若需恢复 HTTP 访问，将 <code>auto_https on</code> 改为 <code>auto_https off</code>，重启 Caddy 即可；</li><li><strong>日志查看</strong>：<code>tail -f /var/log/caddy/caddy.log</code>，可查看 HTTPS 启动及证书申请日志。</li></ul>`,26)])])}const y=s(e,[["render",p]]);export{k as __pageData,y as default};
