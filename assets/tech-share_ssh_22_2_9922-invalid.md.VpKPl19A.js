import{_ as a,o as i,c as n,a2 as t}from"./chunks/framework.C766EroN.js";const c=JSON.parse('{"title":"SSH更改成其他端口无效","description":"Ubuntu 24.04：SSH 端口从 22 修改至 9922 的故障排查与解决方案","frontmatter":{"title":"SSH更改成其他端口无效","description":"Ubuntu 24.04：SSH 端口从 22 修改至 9922 的故障排查与解决方案"},"headers":[],"relativePath":"tech-share/ssh/22_2_9922-invalid.md","filePath":"tech-share/ssh/22_2_9922-invalid.md"}'),l={name:"tech-share/ssh/22_2_9922-invalid.md"};function h(e,s,p,k,d,o){return i(),n("div",null,[...s[0]||(s[0]=[t(`<h1 id="ubuntu-24-04-ssh-端口从-22-修改至-9922-的故障排查与解决方案" tabindex="-1">Ubuntu 24.04：SSH 端口从 22 修改至 9922 的故障排查与解决方案 <a class="header-anchor" href="#ubuntu-24-04-ssh-端口从-22-修改至-9922-的故障排查与解决方案" aria-label="Permalink to &quot;Ubuntu 24.04：SSH 端口从 22 修改至 9922 的故障排查与解决方案&quot;">​</a></h1><blockquote><p>编辑日期：2026-02-27</p></blockquote><h2 id="文档信息" tabindex="-1">文档信息 <a class="header-anchor" href="#文档信息" aria-label="Permalink to &quot;文档信息&quot;">​</a></h2><table tabindex="0"><thead><tr><th>项目</th><th>内容</th></tr></thead><tbody><tr><td>适用系统</td><td>Ubuntu 24.04 LTS</td></tr><tr><td>目标端口</td><td>9922（TCP）</td></tr><tr><td>核心问题</td><td>配置文件已写入<code>Port 9922</code>，但SSH服务仅监听22端口，本地连接9922端口提示<code>Connection refused</code></td></tr><tr><td>文档用途</td><td>记录故障排查流程、核心原因分析及可落地的解决方案，用于技术沉淀与复用</td></tr></tbody></table><h2 id="一、故障现状与核心排查结论" tabindex="-1">一、故障现状与核心排查结论 <a class="header-anchor" href="#一、故障现状与核心排查结论" aria-label="Permalink to &quot;一、故障现状与核心排查结论&quot;">​</a></h2><h3 id="_1-故障表现" tabindex="-1">1. 故障表现 <a class="header-anchor" href="#_1-故障表现" aria-label="Permalink to &quot;1. 故障表现&quot;">​</a></h3><ol><li><p>执行<code>grep -E &quot;^Port&quot; /etc/ssh/sshd_config</code>，确认配置文件已正确写入<code>Port 22</code>和<code>Port 9922</code>；</p></li><li><p>执行<code>sshd -t</code>，配置语法校验无报错；</p></li><li><p>启动SSH服务后，<code>systemctl status ssh</code>日志仅显示监听22端口，无9922端口监听记录；</p></li><li><p>执行<code>ssh localhost -p 9922</code>，提示<code>Connection refused</code>；</p></li><li><p>排查<code>/etc/ssh/sshd_config.d/</code>目录，确认无覆盖主配置的子配置文件。</p></li></ol><h3 id="_2-核心原因" tabindex="-1">2. 核心原因 <a class="header-anchor" href="#_2-核心原因" aria-label="Permalink to &quot;2. 核心原因&quot;">​</a></h3><p>SSH服务由<code>ssh.socket</code>触发启动（systemd 套接字激活机制），该机制会<strong>忽略配置文件中的端口设置</strong>，仅加载默认22端口，导致自定义端口配置失效。</p><h2 id="二、前置准备-避免操作中断" tabindex="-1">二、前置准备（避免操作中断） <a class="header-anchor" href="#二、前置准备-避免操作中断" aria-label="Permalink to &quot;二、前置准备（避免操作中断）&quot;">​</a></h2><ol><li><p>确保UFW防火墙已放行9922端口（已完成，验证命令：<code>sudo ufw status</code>）；</p></li><li><p><strong>保持当前SSH会话不关闭</strong>，新开终端执行后续操作，防止配置错误导致远程连接断开。</p></li></ol><h2 id="三、分步解决方案" tabindex="-1">三、分步解决方案 <a class="header-anchor" href="#三、分步解决方案" aria-label="Permalink to &quot;三、分步解决方案&quot;">​</a></h2><h3 id="阶段1-彻底关闭套接字激活机制-核心步骤" tabindex="-1">阶段1：彻底关闭套接字激活机制（核心步骤） <a class="header-anchor" href="#阶段1-彻底关闭套接字激活机制-核心步骤" aria-label="Permalink to &quot;阶段1：彻底关闭套接字激活机制（核心步骤）&quot;">​</a></h3><p><code>ssh.socket</code>是导致端口配置失效的关键，需停止并禁用该套接字，强制SSH服务通过配置文件加载端口。</p><div class="language-Bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. 停止SSH服务及关联的套接字</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ssh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ssh.socket</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. 永久禁用ssh.socket，避免开机自动触发</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> disable</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --now</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ssh.socket</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 3. 验证套接字状态（输出应为inactive）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ssh.socket</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --no-pager</span></span></code></pre></div><h3 id="阶段2-确认主配置文件完整性" tabindex="-1">阶段2：确认主配置文件完整性 <a class="header-anchor" href="#阶段2-确认主配置文件完整性" aria-label="Permalink to &quot;阶段2：确认主配置文件完整性&quot;">​</a></h3><p>虽无子配置覆盖，但需确保主配置文件无隐性问题，且包含子配置目录的引用（规范要求）。</p><div class="language-Bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. 检查配置文件中Port参数是否唯一且格式正确</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -E</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;^Port&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/ssh/sshd_config</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. 检查是否包含子配置目录引用（无则添加）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -E</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;^Include&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/ssh/sshd_config</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 若无输出，执行以下命令添加</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Include /etc/ssh/sshd_config.d/*.conf&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tee</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/ssh/sshd_config</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 3. 再次校验配置文件语法（无输出即正常）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sshd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span></span></code></pre></div><h3 id="阶段3-重启ssh服务并验证端口监听" tabindex="-1">阶段3：重启SSH服务并验证端口监听 <a class="header-anchor" href="#阶段3-重启ssh服务并验证端口监听" aria-label="Permalink to &quot;阶段3：重启SSH服务并验证端口监听&quot;">​</a></h3><div class="language-Bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. 启动SSH服务（基于配置文件加载）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ssh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. 验证服务状态（确认无报错，且日志包含9922端口监听）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ssh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --no-pager</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 3. 验证端口监听（需同时显示22和9922端口）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ss</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -tuln</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -E</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;22|9922&quot;</span></span></code></pre></div><p><strong>正常输出示例</strong>：</p><div class="language-Plain vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Plain</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span></span></span>
<span class="line"><span>tcp   LISTEN 0      128        0.0.0.0:22        0.0.0.0:*</span></span>
<span class="line"><span>tcp   LISTEN 0      128        0.0.0.0:9922      0.0.0.0:*</span></span>
<span class="line"><span>tcp   LISTEN 0      128           [::]:22           [::]:*</span></span>
<span class="line"><span>tcp   LISTEN 0      128           [::]:9922         [::]:*</span></span></code></pre></div><h3 id="阶段4-功能测试与最终加固" tabindex="-1">阶段4：功能测试与最终加固 <a class="header-anchor" href="#阶段4-功能测试与最终加固" aria-label="Permalink to &quot;阶段4：功能测试与最终加固&quot;">​</a></h3><ol><li><strong>本地连接测试</strong></li></ol><div class="language-Bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> localhost</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 9922</span></span></code></pre></div><p>提示输入密码即代表连接成功。</p><ol><li><strong>远程连接测试</strong></li></ol><div class="language-Bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 用户名@服务器IP</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 9922</span></span></code></pre></div><ol><li><strong>（可选）关闭22端口（测试稳定后执行）</strong></li></ol><div class="language-Bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 编辑配置文件，删除Port 22</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nano</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/ssh/sshd_config</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 仅保留：Port 9922</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 重启服务</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ssh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 删除防火墙22端口规则</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ufw</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> delete</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> allow</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 22/tcp</span></span></code></pre></div><h2 id="四、常见故障兜底方案" tabindex="-1">四、常见故障兜底方案 <a class="header-anchor" href="#四、常见故障兜底方案" aria-label="Permalink to &quot;四、常见故障兜底方案&quot;">​</a></h2><p>若上述步骤执行后仍未解决，执行以下兜底操作：</p><ol><li><strong>重新生成SSH配置文件</strong></li></ol><div class="language-Bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 备份原配置文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/ssh/sshd_config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/ssh/sshd_config.bak</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 重新生成默认配置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dpkg-reconfigure</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> openssh-server</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 重新编辑新配置文件，添加Port 9922</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nano</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/ssh/sshd_config</span></span></code></pre></div><ol><li><strong>重启系统验证</strong></li></ol><div class="language-Bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">Bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> reboot</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 重启后执行：sudo ss -tuln | grep 9922</span></span></code></pre></div><h2 id="五、关键知识点沉淀" tabindex="-1">五、关键知识点沉淀 <a class="header-anchor" href="#五、关键知识点沉淀" aria-label="Permalink to &quot;五、关键知识点沉淀&quot;">​</a></h2><ol><li><p><strong>Ubuntu 24.04 SSH 启动机制</strong>：默认采用<code>socket</code>激活，该机制优先使用默认端口，会忽略配置文件中的自定义端口；</p></li><li><p><strong>配置优先级</strong>：<code>/etc/ssh/sshd_config.d/*.conf</code> &gt; <code>/etc/ssh/sshd_config</code>，若无中子配置，需确保主配置包含<code>Include</code>语句；</p></li><li><p><strong>安全原则</strong>：修改端口时，先保留原端口测试，确认新端口可用后再关闭原端口，避免断连。</p></li></ol><blockquote><p>（注：文档部分内容可能由 AI 生成）</p></blockquote>`,39)])])}const F=a(l,[["render",h]]);export{c as __pageData,F as default};
