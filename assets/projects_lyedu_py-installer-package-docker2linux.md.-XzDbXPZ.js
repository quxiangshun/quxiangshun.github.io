import{_ as i,o as a,c as t,a2 as n}from"./chunks/framework.C766EroN.js";const c=JSON.parse('{"title":"LyEdu Linux 可执行文件构建流程","description":"","frontmatter":{},"headers":[],"relativePath":"projects/lyedu/py-installer-package-docker2linux.md","filePath":"projects/lyedu/py-installer-package-docker2linux.md"}'),l={name:"projects/lyedu/py-installer-package-docker2linux.md"};function e(p,s,h,d,k,r){return a(),t("div",null,[...s[0]||(s[0]=[n(`<h1 id="lyedu-linux-可执行文件构建流程" tabindex="-1">LyEdu Linux 可执行文件构建流程 <a class="header-anchor" href="#lyedu-linux-可执行文件构建流程" aria-label="Permalink to &quot;LyEdu Linux 可执行文件构建流程&quot;">​</a></h1><p>本文档描述在 Windows 环境下，通过 Docker 生成 Linux 平台可执行文件 <code>lyedu_backend</code> 的完整流程，包含每行代码的解析。</p><hr><h2 id="一、流程概览" tabindex="-1">一、流程概览 <a class="header-anchor" href="#一、流程概览" aria-label="Permalink to &quot;一、流程概览&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[Windows 主机]</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ├─ 1. 执行 build.ps1</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ├─ 2. Docker 拉取 python:3.10-slim-bullseye 镜像</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ├─ 3. 安装 requirements.txt + PyInstaller</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ├─ 4. 复制源码，执行 PyInstaller 打包</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ├─ 5. 导出单文件 lyedu_backend 到 dist/</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    └─ 产出: lyedu-api-python/dist/lyedu_backend（Linux ELF 可执行文件）</span></span></code></pre></div><p><strong>前置条件</strong>：已安装并启动 Docker Desktop。</p><hr><h2 id="二、build-ps1-构建脚本" tabindex="-1">二、build.ps1 构建脚本 <a class="header-anchor" href="#二、build-ps1-构建脚本" aria-label="Permalink to &quot;二、build.ps1 构建脚本&quot;">​</a></h2><p><strong>路径</strong>：<code>lyedu-api-python/build.ps1</code><br><strong>作用</strong>：在仓库根目录执行，调用 Docker 构建并导出产物到 <code>lyedu-api-python/dist/</code>。</p><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># LyEdu build.ps1 - Docker 构建 Linux 可执行文件</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 产出: lyedu-api-python/dist/lyedu_backend</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用: .\\lyedu-api-python\\build.ps1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 国内网络默认使用清华镜像，直连 Docker Hub 可设: $env:DOCKER_REGISTRY=&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$ErrorActionPreference</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Stop&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$RepoRoot </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$PSScriptRoot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Split-Path</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $PSScriptRoot</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Parent } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Split-Path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Get-Location</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Parent }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$DistDir </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Join-Path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $RepoRoot </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;lyedu-api-python\\dist&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$DistFile </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Join-Path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $DistDir </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;lyedu_backend&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">New-Item</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ItemType Directory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Force </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Path $DistDir </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Out-Null</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Dockerfile 已内置国内镜像默认值，直连 Docker Hub 可传: --build-arg DOCKER_REGISTRY= --build-arg PIP_INDEX=</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Write-Host</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[LyEdu] Building in Docker (Linux target) ...&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ForegroundColor Cyan</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">env:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DOCKER_BUILDKIT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;1&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$dest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Resolve-Path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $DistDir).Path</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$argList </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> @</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;build&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;-f&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;lyedu-api-python/Dockerfile.build&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;--target&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;export&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;--progress=plain&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;--output&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;type=local,dest=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$dest</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;.&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">env:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DOCKER_REGISTRY) { $argList </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;--build-arg&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;DOCKER_REGISTRY=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">env:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DOCKER_REGISTRY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">env:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PIP_INDEX) { $argList </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;--build-arg&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;PIP_INDEX=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">env:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PIP_INDEX</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Push-Location</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $RepoRoot</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    $ErrorActionPreference</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Continue&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> docker @argList</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    $ErrorActionPreference</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Stop&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Pop-Location</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Test-Path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $DistFile) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Write-Host</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[LyEdu] Build done: lyedu-api-python\\dist\\lyedu_backend&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ForegroundColor Green</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Write-Host</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[LyEdu] Output not found, check build log above.&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ForegroundColor Yellow</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="逐行解析" tabindex="-1">逐行解析 <a class="header-anchor" href="#逐行解析" aria-label="Permalink to &quot;逐行解析&quot;">​</a></h3><table tabindex="0"><thead><tr><th>行号</th><th>代码</th><th>解析</th></tr></thead><tbody><tr><td>6</td><td><code>$ErrorActionPreference = &quot;Stop&quot;</code></td><td>遇到错误时停止执行，避免静默失败</td></tr><tr><td>7</td><td><code>$RepoRoot = if ($PSScriptRoot) { Split-Path $PSScriptRoot -Parent } else { Split-Path (Get-Location) -Parent }</code></td><td>获取仓库根目录：脚本在 <code>lyedu-api-python/</code> 下，<code>$PSScriptRoot</code> 为其目录，<code>-Parent</code> 得到 LyEdu 根目录</td></tr><tr><td>8</td><td><code>$DistDir = Join-Path $RepoRoot &quot;lyedu-api-python\\dist&quot;</code></td><td>构建产物目录：<code>&lt;仓库根&gt;/lyedu-api-python/dist</code></td></tr><tr><td>9</td><td><code>$DistFile = Join-Path $DistDir &quot;lyedu_backend&quot;</code></td><td>最终可执行文件路径：<code>&lt;仓库根&gt;/lyedu-api-python/dist/lyedu_backend</code></td></tr><tr><td>11</td><td><code>New-Item -ItemType Directory -Force -Path $DistDir | Out-Null</code></td><td>强制创建目录，不存在则创建，<code>Out-Null</code> 丢弃输出</td></tr><tr><td>15</td><td><code>$env:DOCKER_BUILDKIT = &quot;1&quot;</code></td><td>启用 BuildKit，支持 <code>--output type=local</code> 导出到本地</td></tr><tr><td>16</td><td><code>$dest = (Resolve-Path $DistDir).Path</code></td><td>获取 <code>dist</code> 的绝对路径，供 Docker 使用</td></tr><tr><td>17-21</td><td><code>$argList = @(...)</code></td><td>构建 <code>docker build</code> 参数列表：<br>• <code>-f lyedu-api-python/Dockerfile.build</code> 指定 Dockerfile<br>• <code>--target export</code> 只构建到 export 阶段<br>• <code>--progress=plain</code> 普通进度输出<br>• <code>--output type=local,dest=$dest</code> 导出到本地</td></tr><tr><td>22-23</td><td><code>if ($env:DOCKER_REGISTRY) { ... }</code></td><td>若设置了环境变量，则传入对应 <code>--build-arg</code>，用于国内镜像</td></tr><tr><td>24</td><td><code>Push-Location $RepoRoot</code></td><td>切换到仓库根目录，Docker 构建上下文需在根目录</td></tr><tr><td>26</td><td><code>$ErrorActionPreference = &quot;Continue&quot;</code></td><td>临时允许继续执行，避免 Docker 的 stderr 导致脚本中断</td></tr><tr><td>27</td><td><code>&amp; docker @argList</code></td><td>执行 <code>docker build</code>，<code>@argList</code> 展开为参数</td></tr><tr><td>29</td><td><code>Pop-Location</code></td><td>恢复原工作目录</td></tr><tr><td>33-37</td><td><code>if (Test-Path $DistFile) { ... } else { ... }</code></td><td>检查产物是否存在，成功则提示路径，失败则退出码 1</td></tr></tbody></table><hr><h2 id="三、dockerfile-build" tabindex="-1">三、Dockerfile.build <a class="header-anchor" href="#三、dockerfile-build" aria-label="Permalink to &quot;三、Dockerfile.build&quot;">​</a></h2><p><strong>路径</strong>：<code>lyedu-api-python/Dockerfile.build</code><br><strong>作用</strong>：多阶段构建，在 Linux 容器内完成 PyInstaller 打包并导出单文件。</p><div class="language-dockerfile vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># LyEdu 后端 PyInstaller 打包镜像（分层构建，基础环境缓存复用）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用: 见 lyedu-api-python/build.ps1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 分层说明:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   Stage base  - Python + requirements + PyInstaller（仅在 requirements 变更时重建）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   Stage builder - 复制源码并打包（源码变更时重建，复用 base 缓存）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 国内网络: 默认 1ms 镜像，直连可传 --build-arg DOCKER_REGISTRY=</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ARG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DOCKER_REGISTRY=docker.1ms.run/library/</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ARG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PIP_INDEX=https://pypi.tuna.tsinghua.edu.cn/simple</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ========== Stage 1: 基础环境（显式 -bullseye 锁定 GLIBC 2.31，兼容 CentOS 8、Ubuntu 20.04 等） ==========</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${DOCKER_REGISTRY}python:3.10-slim-bullseye </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> base</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ARG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PIP_INDEX</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WORKDIR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /build</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 先只复制依赖文件，利用 Docker 层缓存</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lyedu-api-python/requirements.txt .</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 安装运行时依赖 + PyInstaller，此层会被缓存（PIP_INDEX 为空时使用默认源）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pip install --no-cache-dir \${PIP_INDEX:+-i </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;$PIP_INDEX&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} -r requirements.txt \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &amp;&amp; pip install --no-cache-dir \${PIP_INDEX:+-i </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;$PIP_INDEX&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} pyinstaller</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ========== Stage 2: 打包（源码变更时重建，基础环境复用） ==========</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> base </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> builder</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># PyInstaller 在 Linux 下需要 objdump（来自 binutils）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> apt-get update &amp;&amp; apt-get install -y --no-install-recommends binutils &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 复制完整源码，.dockerignore 排除 build/dist/.venv 等</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lyedu-api-python /build</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WORKDIR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /build</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 执行打包</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> python -m PyInstaller lyedu_backend.spec --clean --distpath /out</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ========== Stage 3: 导出层（scratch 仅含可执行文件，避免 Alpine 符号链接在 Windows 导出失败） ==========</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> scratch </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">AS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> export</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --from=builder /out/lyedu_backend /lyedu_backend</span></span></code></pre></div><h3 id="逐行解析-1" tabindex="-1">逐行解析 <a class="header-anchor" href="#逐行解析-1" aria-label="Permalink to &quot;逐行解析&quot;">​</a></h3><table tabindex="0"><thead><tr><th>行号</th><th>代码</th><th>解析</th></tr></thead><tbody><tr><td>9</td><td><code>ARG DOCKER_REGISTRY=docker.1ms.run/library/</code></td><td>构建参数，默认使用国内 Docker 镜像；直连时可传空</td></tr><tr><td>10</td><td><code>ARG PIP_INDEX=https://pypi.tuna.tsinghua.edu.cn/simple</code></td><td>默认 PyPI 镜像，国内加速</td></tr><tr><td>13</td><td><code>FROM \${DOCKER_REGISTRY}python:3.10-slim-bullseye AS base</code></td><td>基础镜像：Python 3.10，Debian Bullseye，GLIBC 2.31，兼容 CentOS 8、Ubuntu 20.04 等</td></tr><tr><td>15</td><td><code>ARG PIP_INDEX</code></td><td>在 base 阶段再次声明，以便 <code>RUN</code> 使用</td></tr><tr><td>17</td><td><code>WORKDIR /build</code></td><td>工作目录设为 <code>/build</code></td></tr><tr><td>20</td><td><code>COPY lyedu-api-python/requirements.txt .</code></td><td>仅复制依赖文件，便于依赖未变时复用缓存</td></tr><tr><td>23-24</td><td><code>RUN pip install ...</code></td><td>安装依赖：<code>\${PIP_INDEX:+-i &quot;$PIP_INDEX&quot;}</code> 表示 PIP_INDEX 非空时加 <code>-i</code> 参数；安装 requirements 和 pyinstaller</td></tr><tr><td>27</td><td><code>FROM base AS builder</code></td><td>第二阶段，继承 base</td></tr><tr><td>30</td><td><code>RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends binutils &amp;&amp; rm -rf /var/lib/apt/lists/*</code></td><td>安装 binutils（提供 objdump），PyInstaller 在 Linux 下需要；删除 apt 缓存减小镜像</td></tr><tr><td>33</td><td><code>COPY lyedu-api-python /build</code></td><td>复制源码到 <code>/build</code>，<code>.dockerignore</code> 会排除 build/dist/.venv 等</td></tr><tr><td>35</td><td><code>WORKDIR /build</code></td><td>工作目录设为 <code>/build</code></td></tr><tr><td>38</td><td><code>RUN python -m PyInstaller lyedu_backend.spec --clean --distpath /out</code></td><td>执行 PyInstaller：<code>--clean</code> 清理缓存，<code>--distpath /out</code> 输出到 <code>/out</code></td></tr><tr><td>41</td><td><code>FROM scratch AS export</code></td><td>导出阶段：空镜像，无文件系统，避免符号链接和多余依赖</td></tr><tr><td>42</td><td><code>COPY --from=builder /out/lyedu_backend /lyedu_backend</code></td><td>从 builder 阶段复制 <code>/out/lyedu_backend</code> 到 <code>/lyedu_backend</code>，供 BuildKit 导出</td></tr></tbody></table><hr><h2 id="四、lyedu-backend-spec-pyinstaller-配置" tabindex="-1">四、lyedu_backend.spec（PyInstaller 配置） <a class="header-anchor" href="#四、lyedu-backend-spec-pyinstaller-配置" aria-label="Permalink to &quot;四、lyedu_backend.spec（PyInstaller 配置）&quot;">​</a></h2><p><strong>路径</strong>：<code>lyedu-api-python/lyedu_backend.spec</code><br><strong>作用</strong>：与 Windows exe 共用，定义 PyInstaller 打包规则。</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># -*- mode: python ; coding: utf-8 -*-</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 打包 alembic.ini 和 alembic 目录，首次运行 exe 时复制到 ~/.lyedu/（与 config.ini 同层级）</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Analysis(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;main.py&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 入口脚本</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    pathex</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    binaries</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    datas</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;alembic.ini&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 打包数据库迁移配置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;alembic&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;alembic&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 打包迁移脚本目录</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pyz </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PYZ(a.pure)             </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 纯 Python 模块</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">exe </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EXE(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    pyz, a.scripts, a.binaries, a.datas,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [],</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;lyedu_backend&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 输出文件名（Linux 无 .exe）</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    icon</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;favicon.ico&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 仅 Windows/macOS 生效</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="关键配置" tabindex="-1">关键配置 <a class="header-anchor" href="#关键配置" aria-label="Permalink to &quot;关键配置&quot;">​</a></h3><table tabindex="0"><thead><tr><th>配置</th><th>说明</th></tr></thead><tbody><tr><td><code>main.py</code></td><td>程序入口</td></tr><tr><td><code>datas</code></td><td>将 alembic.ini 和 alembic 目录打包进可执行文件</td></tr><tr><td><code>name=&#39;lyedu_backend&#39;</code></td><td>Linux 下输出为 <code>lyedu_backend</code>，Windows 下为 <code>lyedu_backend.exe</code></td></tr></tbody></table><hr><h2 id="五、运行方式" tabindex="-1">五、运行方式 <a class="header-anchor" href="#五、运行方式" aria-label="Permalink to &quot;五、运行方式&quot;">​</a></h2><h3 id="_1-构建" tabindex="-1">1. 构建 <a class="header-anchor" href="#_1-构建" aria-label="Permalink to &quot;1. 构建&quot;">​</a></h3><p>在仓库根目录或 <code>lyedu-api-python</code> 目录执行：</p><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.\\lyedu</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">api</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">python\\build.ps1</span></span></code></pre></div><h3 id="_2-产物" tabindex="-1">2. 产物 <a class="header-anchor" href="#_2-产物" aria-label="Permalink to &quot;2. 产物&quot;">​</a></h3><ul><li>路径：<code>lyedu-api-python/dist/lyedu_backend</code></li><li>类型：Linux ELF 可执行文件，单文件，无需系统 Python</li></ul><h3 id="_3-在-linux-上运行" tabindex="-1">3. 在 Linux 上运行 <a class="header-anchor" href="#_3-在-linux-上运行" aria-label="Permalink to &quot;3. 在 Linux 上运行&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lyedu_backend</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./lyedu_backend</span></span></code></pre></div><p>配置与 exe 相同：优先使用 <code>~/.lyedu/conf/config.ini</code>，首次运行会从 <code>alembic</code> 生成迁移目录。</p><h3 id="_4-直连-docker-hub-时" tabindex="-1">4. 直连 Docker Hub 时 <a class="header-anchor" href="#_4-直连-docker-hub-时" aria-label="Permalink to &quot;4. 直连 Docker Hub 时&quot;">​</a></h3><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">env:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DOCKER_REGISTRY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">env:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PIP_INDEX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.\\lyedu</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">api</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">python\\build.ps1</span></span></code></pre></div><hr><h2 id="六、依赖关系说明" tabindex="-1">六、依赖关系说明 <a class="header-anchor" href="#六、依赖关系说明" aria-label="Permalink to &quot;六、依赖关系说明&quot;">​</a></h2><table tabindex="0"><thead><tr><th>依赖</th><th>说明</th></tr></thead><tbody><tr><td>系统 Python</td><td>不需要，PyInstaller 已打包解释器</td></tr><tr><td>系统 GLIBC</td><td>需要，目标系统 GLIBC ≥ 2.31（Bullseye 对应版本）</td></tr><tr><td>配置文件</td><td>使用 <code>~/.lyedu/conf/config.ini</code>（MySQL、Redis 等）</td></tr></tbody></table><hr><h2 id="七、常见问题" tabindex="-1">七、常见问题 <a class="header-anchor" href="#七、常见问题" aria-label="Permalink to &quot;七、常见问题&quot;">​</a></h2><ol><li><strong>GLIBC 版本不足</strong>：若目标系统 GLIBC &lt; 2.31，需改用更老的基础镜像（如 <code>python:3.10-slim-buster</code>），或升级目标系统。</li><li><strong>Docker 构建失败</strong>：国内网络可优先使用 Dockerfile 中默认的 1ms 镜像；若需更换，可设置 <code>DOCKER_REGISTRY</code>。</li></ol>`,42)])])}const E=i(l,[["render",e]]);export{c as __pageData,E as default};
